<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>request.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-createError.html">createError</a><ul class='methods'><li data-type='method'><a href="module-createError.html#~createError">createError</a></li></ul></li><li><a href="module-download.html">download</a><ul class='methods'><li data-type='method'><a href="module-download.html#~download">download</a></li></ul></li><li><a href="module-extract.html">extract</a><ul class='methods'><li data-type='method'><a href="module-extract.html#~extract">extract</a></li></ul></li><li><a href="module-index.html">index</a><ul class='methods'><li data-type='method'><a href="module-index.html#~fetch">fetch</a></li><li data-type='method'><a href="module-index.html#~locate">locate</a></li><li data-type='method'><a href="module-index.html#~match">match</a></li><li data-type='method'><a href="module-index.html#~releases">releases</a></li></ul></li><li><a href="module-request.html">request</a><ul class='methods'><li data-type='method'><a href="module-request.html#~communication">communication</a></li><li data-type='method'><a href="module-request.html#~findFeedId">findFeedId</a></li><li data-type='method'><a href="module-request.html#~req">req</a></li></ul></li><li><a href="module-utils.html">utils</a><ul class='methods'><li data-type='method'><a href="module-utils.html#~extractRefs">extractRefs</a></li><li data-type='method'><a href="module-utils.html#~extractReleases">extractReleases</a></li><li data-type='method'><a href="module-utils.html#~registryParser">registryParser</a></li><li data-type='method'><a href="module-utils.html#~releases">releases</a></li><li data-type='method'><a href="module-utils.html#~tags">tags</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">request.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

/**
 * Request module.
 * @module request
 */

const request = require("request");
const Promise = require("bluebird");
const Url = require("url");
const createError = require("./createError");

/**
 * Communication with the server
 *
 * @param {string} url - The requested url
 * @param {string} adr - The API formatted url
 * @param {function} resolve - The Promise pass answer
 * @param {function} reject - The Promise fail answer
 * @param {{}} params - The parameters for the API call
 * @param {{}} config - The bower configuration
 */
function communication(url, adr, resolve, reject, params, config) {
    let _request = request.defaults({
        proxy: Url.parse(url).protocol === "https:" ? config.httpsProxy : config.proxy,
        ca: config.ca.search[0],
        strictSSL: config.strictSsl,
        timeout: config.timeout,
        qs: params
    });

    _request = _request.defaults(config.request || {});

    _request(adr, function(error, response, body) {
        if (error) {
            reject(createError(`Request to ${url} failed: ${error.message}`, error.code));
        } else {
            if (response.statusCode === 200) {
                resolve(body);
            } else {
                reject(createError(`Request to ${url} returned ${response.statusCode} status code.`, "EREQUEST", {
                    details: response.toString()
                }));
            }
        }
    });
}

/**
 * Find the Feed ID from a feed name
 *
 * @param {string} url - The requested url
 * @param {function} reject - The Promise fail answer
 * @param {{}} params - The parameters for the API call
 * @param {{}} config - The bower configuration
 * @param {function} callback
 */
function findFeedId(url, reject, params, config, callback) {
    let reqID = url.split("?")[0] + "/api/json/Feeds_GetFeed";

    communication(url, reqID, callback, reject, {Feed_Name: params.Feed_Id, API_Key: params.API_Key}, config);
}

/**
 * Send GET request to the host
 *
 * @param {string} requestUrl - The url of the request
 * @param {string} apiMethod - The ProGet api method to use
 * @param {{}} config - The Bower configuration
 * @returns {Promise}
 */
let req = (requestUrl, apiMethod, config) => {
    return new Promise((resolve, reject) => {
        if (!config.hasOwnProperty("proget")) {
            reject(createError("Missing parameter 'proget' in Bower configuration.", "EBOWERC"));
        }

        let rUrl = requestUrl.split("?"),
            adr = rUrl[0] + "/api/json/" + apiMethod,
            rParams = rUrl[1].split("/");

        // Prepare the request
        let params = {
            API_Key: config.proget.apiKey || "",
            Feed_Id: rParams[0],
            Group_Name: rParams[1] || "bower",
            Package_Name: rParams[2]
        };

        if (params.API_Key === "") {
            reject(createError("Their is no 'apiKey' set on your system, please add one to you .bowerrc file. Seed documentation for HowTo.", "EMISSAPIKEY"));
        }

        // Test if we have the id or the feed name
        if (/^\d+$/.test(rParams[0])) {
            // If we have an ID
            communication(requestUrl, adr, resolve, reject, params, config);
        } else {
            // If we have a name
            findFeedId(requestUrl, reject, params, config, (data) => {
                if (data) {
                    params.Feed_Id = JSON.parse(data).Feed_Id;
                    communication(requestUrl, adr, resolve, reject, params, config);
                } else {
                    reject(createError(`Unable to found the Feed with the name ${params.Feed_Id}`, "EBOWERC"));
                }
            });
        }
    });
};

module.exports = req;</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Sun Sep 25 2016 13:00:12 GMT-0400 (Est (heure d’été)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
