<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-progetApi-ProgetApi.html">ProgetApi</a><ul class='methods'><li data-type='method'><a href="module-progetApi-ProgetApi.html#.extractReleases">extractReleases</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#.urlToKey">urlToKey</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#communicate">communicate</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#fillCache">fillCache</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#findFeedId">findFeedId</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#generatePossibleUrl">generatePossibleUrl</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#getFeedDetails">getFeedDetails</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#getPackagesSingle">getPackagesSingle</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#getPackageVersions">getPackageVersions</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#isSupportedServer">isSupportedServer</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#locatePackage">locatePackage</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#sendRequest">sendRequest</a></li><li data-type='method'><a href="module-progetApi-ProgetApi.html#supportsPackage">supportsPackage</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-createError.html">createError</a><ul class='methods'><li data-type='method'><a href="module-createError.html#~createError">createError</a></li></ul></li><li><a href="module-download.html">download</a><ul class='methods'><li data-type='method'><a href="module-download.html#~download">download</a></li></ul></li><li><a href="module-extract.html">extract</a><ul class='methods'><li data-type='method'><a href="module-extract.html#~extract">extract</a></li></ul></li><li><a href="module-index.html">index</a><ul class='methods'><li data-type='method'><a href="module-index.html#~fetch">fetch</a></li><li data-type='method'><a href="module-index.html#~isSourceUrl">isSourceUrl</a></li><li data-type='method'><a href="module-index.html#~locate">locate</a></li><li data-type='method'><a href="module-index.html#~match">match</a></li><li data-type='method'><a href="module-index.html#~releases">releases</a></li></ul></li><li><a href="module-progetApi.html">progetApi</a><ul class='methods'><li data-type='method'><a href="module-progetApi.html#~extractRefs">extractRefs</a></li><li data-type='method'><a href="module-progetApi.html#~releases">releases</a></li><li data-type='method'><a href="module-progetApi.html#~tags">tags</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

/**
 * Main module.
 * @module index
 */

// Prepare the temp module
const tmp = require("tmp");
tmp.setGracefulCleanup();

const download = require("./download");
const extract = require("./extract");
const progetAPI = require("../lib/progetApi");

/**
 * Test the format of the source URL
 *
 * @param {String} source - The URL to validate
 * @returns {boolean}
 */
function isSourceUrl(source) {
    return /^(https?|ssh|git):\/\/.*/.test(source);
}

/**
 * Main module section
 *
 * @param {bowerObj} bower
 * @return {*}
 */
module.exports = function resolver(bower) {
    let api = new progetAPI(bower);

    return {
        /**
         * Tells Bower whether to use or not use this resolver for some source.
         *
         * @returns {boolean|Promise} - Tells whether resolver can handle given source
         */
        match: function(source) {
            if (isSourceUrl(source)) {
                return api.isSupportedServer(source);
            } else {
                // Is the short form and need to be validated against the feed packages
                return api.fillCache(source)
                    .then(function() {
                        return api.supportsPackage(source);
                    });
            }
        },

        /**
         * Allows to implement simplified registry
         *
         * @param {string} source - Source from bower.json
         * @returns {string} - Resolved source string
         */
        locate(source) {
            if (/^https?:\/\/.*/.test(source) || source.indexOf("?") != -1) {
                return source;
            } else {
                return api.locatePackage(source);
            }
        },

        /**
         * Bower selects one matching version from the result and passes matching target field to fetch method.
         *
         * @param {string} source - Source from bower.json
         * @returns {Promise}
         */
        releases(source) {
            return api.getPackageVersions(source);
        },

        /**
         * Downloads given endpoint and returns path to temporary directory
         *
         * @param {{name: string, source: string, target: string}} endpoint - Endpoint for the resource to download
         * @param {{}} cached  - Contains information about cached resource
         * @param {endpoint} cached.endpoint - Endpoint of cached resource
         * @param {string} cached.release - The must plausible cache version
         * @param {Array} [cached.releases] - The version available in cache
         * @param {string} cached.version - Present cached resource has been resolved as version
         * @param {string|{}} cached.resolution - The “resolution” returned from previous fetch call for same resource
         * @returns {Promise}
         */
        fetch(endpoint, cached) {
            if (cached.version !== endpoint.target) {
                return api.getFeedDetails(endpoint.source).then((feedDetails) => {
                    let adrInfo = endpoint.source.split("?");
                    let params = adrInfo[1].split("/");

                    // Url ex: http://&lt;yourProget.com>/upack/&lt;universal-feed-name>/download/bower/&lt;packageName>/&lt;0.0.0>
                    let downloadUrl = `${adrInfo[0]}/upack/${feedDetails.name}/download/bower/${params[2]}/${endpoint.target}`;
                    let downloadPath = tmp.dirSync({unsafeCleanup: true});

                    return download(downloadUrl, downloadPath.name, bower.config).then((archivePatch) => {
                        let extractPath = tmp.dirSync({unsafeCleanup: true});

                        return extract(archivePatch, extractPath.name).then(() => {
                            downloadPath.removeCallback();

                            process.on("exit", ()=> {
                                try {
                                    extractPath.removeCallback();
                                }
                                catch (e) {
                                    // This error can be ignored
                                }
                            });

                            return {
                                tempPath: extractPath.name,
                                removeIgnores: true
                            };
                        });
                    });
                });
            }
        }
    };
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.2</a> on Fri Oct 21 2016 11:15:36 GMT-0400 (Est (heure d’été)) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
